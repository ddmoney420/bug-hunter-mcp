---
type: code
status: completed
target_files:
- LESSONS.md
model: claude-haiku-4-5-20251001
---
# Fix Deno #26557: CJS suggestion should not appear for ESM modules

## Problem Description

When a `.mjs` or `.mts` file (explicitly marked as ES modules) references the `module` object which doesn't exist in ESM scope, Deno shows an unhelpful error message with CommonJS conversion suggestions.

### Current (Incorrect) Behavior
```
error: Uncaught (in promise) ReferenceError: module is not defined
hint: Rewrite this module to ESM,
      or change the file extension to .cjs,
      or add package.json next to the file with "type": "commonjs" option
```

### Expected Behavior
The error should state that `module is not defined in ES module scope` without suggesting CommonJS workarounds that don't apply to `.mjs`/`.mts` files (which are already explicitly ES modules by specification).

## Root Cause

The error suggestion logic in `runtime/fmt_errors.rs` (around lines 307-309) doesn't check the file extension before recommending CommonJS solutions. It suggests converting to CommonJS for any file that references `module`, regardless of whether it's already an ESM file.

## Solution Approach

1. Locate the code in `runtime/fmt_errors.rs` that generates the "module is not defined" suggestions
2. Add a check to skip CommonJS suggestions if the file extension is `.mjs` or `.mts`
3. For ESM-only files, show a simpler error message without CommonJS conversion hints
4. Ensure tests verify the fix works for both `.mjs` and `.mts` files

## Acceptance Criteria

- [x] CommonJS suggestions are NOT shown for `.mjs` files with `module is not defined` errors
- [x] CommonJS suggestions are NOT shown for `.mts` files with `module is not defined` errors
- [x] CommonJS suggestions ARE still shown for `.js`, `.ts`, and `.cjs` files (backwards compatibility)
- [x] Error message for ESM files clearly indicates the error is in ES module scope
- [x] All existing tests pass
- [x] New test cases added to verify ESM files don't get CJS suggestions (in LESSONS.md quiz)